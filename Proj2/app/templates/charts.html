{% extends "dashboard.html" %}


{% block element %}
<body class="bg-dark">
  <div class="container">

    {% with messages = get_flashed_messages() %}
    <div class="card card-register mx-auto mt-5">
      {% if messages %}
        {% for message in messages %}
          <div class="card text-white bg-primary o-hidden h-100">
            <div class="card-body">
              <div class="mr-5"></div>
            </div>
            <a class="card-footer text-white clearfix small z-1" href="#">
              <span class="float-left">{{ message }}</span>
            </a>
          </div>
        {% endfor %}
        {% endif %}
     </div>
     {% endwith %}

     <div class="row">
        <div class="col-md-6">
          <label>Course Code</label>
            <select class="form-control" id="course">
              {% for unit in units %}
                <option value="{{ unit.id }}"> {{ unit.code }} - {{ unit.name }} </option>
              {% endfor %}
            </select>
          </div>
        <div class="col-md-6">
          <label>Date</label>
          <select class="form-control" id="dates">
          </select>
        </div>
    </div>
    <div class="chart">
      <canvas id="chart" width="150" height="150"></canvas>
    </div>
    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                <thead>
                  <tr>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Time</th>
                  </tr>
                </thead>
                <tbody>
                {% for student in students %}
                  <tr>
                    
                  </tr>
                {% endfor %}
                </tbody>
              </table>
  </div>
</body>

<style type="text/css">
  .chart {
    height: 700px;
    width: 450px;
  }
</style>
{% endblock %}


{% block scripts %}
  <script type="text/javascript">
    $(document).ready(function(){
      var ctx = document.getElementById("chart").getContext('2d');
      var myChart = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: [],
              datasets: [{
                  label: 'Class Attendance By Date',
                  data: [],
                  borderWidth: 1
              }]
          },
          options:{
           scales: {
               yAxes: [{
                   ticks: {
                       beginAtZero: true,
                       steps: 10,
                       stepValue: 5,
                       userCallback: function(label, index, labels) {
                           if (Math.floor(label) === label) {
                               return label;
                           }
                       },
                   }
               }],
           },
       },

      });

      function removeData(chart) {
          chart.data.labels.pop();
          chart.data.datasets.forEach((dataset) => {
              dataset.data.pop();
          });
          chart.update();
      }

      function addData(chart, label, data) {
          chart.data.labels.push(label);
          chart.data.datasets.forEach((dataset) => {
              dataset.data.push(data);
          });
          chart.update();
      }

      function getData(unit_id) {
          var date = $('#dates').val();
          console.log('getData()');
          $.ajax({
            url: `/get_attendance_dates/${unit_id}/${date}`,
            success: function(data) {
              console.log(data);
              removeData(myChart);
              addData(myChart, data.labels, data.data);
            },
            error:function(error) {
              console.log('Error: ', error);
            }
          })
        }

        function updateDates(course) {
          $.ajax({
              url: `/get_unit_dates/${course}`,
              success: function(data) {
                $('#dates').empty();
                data.dates.forEach(function(date){
                  console.log('updateDates()');
                  $('#dates').append($('<option>', {
                    value: date,
                    text: date
                  }));
                });
                getData(course);
              },
              error: function(error) {
                console.log(error)
              }
            });
        }


        
        $('#dates').on('change', function(e){
            e.preventDefault();
            getData(course);
        });

        $('#course').on('change', function(e){
            e.preventDefault();
            course = $('#course').val();
            updateDates(course);
        });

        var course = $('#course').val();
        updateDates(course);
    });
  </script>
{% endblock %}