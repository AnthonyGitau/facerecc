{% extends "dashboard.html" %}


{% block element %}
<body class="bg-dark">
  <div class="container">

    {% with messages = get_flashed_messages() %}
    <div class="card card-register mx-auto mt-5">
      {% if messages %}
        {% for message in messages %}
          <div class="card text-white bg-primary o-hidden h-100">
            <div class="card-body">
              <div class="mr-5"></div>
            </div>
            <a class="card-footer text-white clearfix small z-1" href="#">
              <span class="float-left">{{ message }}</span>
            </a>
          </div>
        {% endfor %}
        {% endif %}
     </div>
     {% endwith %}

     
    <div>
        <div class="form-group">
        <label>Course Code</label>
          <select class="form-control" id="course">
            {% for unit in units %}
              <option value="{{ unit.id }}"> {{ unit.code }} - {{ unit.name }} </option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label>Date</label>
          <select class="form-control" id="dates">
            
          </select>
        </div>
      <canvas id="chart" width="50" height="50"></canvas>
    </div>
  </div>
</body>
{% endblock %}


{% block scripts %}
  <script type="text/javascript">
    $(document).ready(function(){
      var ctx = document.getElementById("chart").getContext('2d');
      var myChart = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: [],
              datasets: [{
                  label: '# of Votes',
                  data: [],
                  borderWidth: 1
              }]
          },
      });

      function removeData(chart) {
          chart.data.labels.pop();
          chart.data.datasets.forEach((dataset) => {
              dataset.data.pop();
          });
          chart.update();
      }

      function addData(chart, label, data) {
          chart.data.labels.push(label);
          chart.data.datasets.forEach((dataset) => {
              dataset.data.push(data);
          });
          chart.update();
      }

      function getData(unit_id) {
          var date = $('#dates').val();
          console.log('Date ' + date);
          $.ajax({
            url: `/get_attendance_dates/${unit_id}/${date}`,
            success: function(data) {
              removeData(myChart);
              addData(myChart, data.labels, data.data);
            },
            error:function(error) {
              return null;
            }
          })
        }
        function updateDates(course) {
          $.ajax({
              url: `/get_unit_dates/${course}`,
              success: function(data) {
                data.dates.forEach(function(date){
                  console.log(date);
                  $('#dates').append($('<option>', {
                    value: date,
                    text: date
                  }));
                });
              },
              error: function(error) {
                console.log(error)
              }
            });
        }

        var course = $('#course').val();
        updateDates(course);
        setTimeout(function(){}, 2000)

        getData(course);
        $('#dates').change(function(e){
            e.preventDefault();
            course = $('#course').val();
            date = $('#dates').val();
            getData(course, date);
        });

        $('#course').change(function(e){
            e.preventDefault();
            course = $('#course').val();
            updateDates(course);
        });
    });
  </script>
{% endblock %}