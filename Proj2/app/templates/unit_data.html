{% extends "dashboard.html" %}


{% block element %}
<body class="bg-dark">
  <div class="container">

    {% with messages = get_flashed_messages() %}
    <div class="card card-register mx-auto mt-5">
      {% if messages %}
        {% for message in messages %}
          <div class="card text-white bg-primary o-hidden h-100">
            <div class="card-body">
              <div class="mr-5"></div>
            </div>
            <a class="card-footer text-white clearfix small z-1" href="#">
              <span class="float-left">{{ message }}</span>
            </a>
          </div>
        {% endfor %}
        {% endif %}
     </div>
     {% endwith %}

     <div class="row">
        <div class="col-md-6">
          <label>Unit Code</label>
            <select class="form-control" id="course">
              {% for unit in units %}
                <option value="{{ unit.id }}"> {{ unit.code }} - {{ unit.name }} </option>
              {% endfor %}
            </select>
          </div>
    </div>
    <div class="chart">
      <canvas id="chart" width="100" height="100"></canvas>
    </div>
    <h2>All Students Taking This Course</h2>
    <table class="table table-bordered" width="100%" cellspacing="0">
      <thead>
        <tr>
          <th>Id</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Email</th>
        </tr>
      </thead>
      <tbody id="tableBody">
      {% for student in students %}
         <tr>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</body>

<style type="text/css">
 
</style>
{% endblock %}


{% block scripts %}
  <script type="text/javascript">
    $(document).ready(function(){
      var ctx = document.getElementById("chart").getContext('2d');
      var myChart = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: [],
              datasets: [{
                  label: 'Class Attendance By Date',
                  data: [],
                  borderWidth: 1,
                  backgroundColor: 'rgba(253, 203, 110,1.0)',
                  backgroundColor: 'rgba(253, 203, 110,1.0)',
                  backgroundColor: 'rgba(253, 203, 110,1.0)',
                  backgroundColor: 'rgba(253, 203, 110,1.0)',
                  backgroundColor: 'rgba(253, 203, 110,1.0)',
              }]
          },
          options:{
           scales: {
               yAxes: [{
                   ticks: {
                       beginAtZero: true,
                       steps: 10,
                       stepValue: 5,
                       userCallback: function(label, index, labels) {
                           if (Math.floor(label) === label) {
                               return label;
                           }
                       },
                   }
               }],
           },
       },

      });

      function removeData(chart) {
          chart.data.labels.pop();
          chart.data.datasets.forEach((dataset) => {
              dataset.data.pop();
          });
          chart.update();
      }

      function addData(chart, label, data) {
          chart.data.labels.push(label);
          chart.data.datasets.forEach((dataset) => {
              dataset.data.push(data);
          });
          chart.update();
      }

      function updateData(unit_id) {
              $.ajax({
                url: `/get_unit_students/${unit_id}`,
                success: function(data) {
                  console.log(data);
                  var students = data.students;
                  var attendance_data = data.attendance_data;
                  console.log('Attendance Data ', attendance_data);
                  $('#tableBody').empty();
                  students.forEach(function(student){
                    $('#tableBody').append(`
                        <tr>
                        <td>${student.student_id}</td>
                        <td>${student.first_name}</td>
                        <td>${student.last_name}</td>
                        <td>${student.email}</td>
                      </tr>
                      `)
                  })
                  removeData(myChart);
                  addData(myChart, attendance_data.labels, attendance_data.data);
                },
                error:function(error) {
                  console.log('Error: ', error);
                }
              })
        }

        $('#course').on('change', function(e){
            e.preventDefault();
            course = $('#course').val();
            updateData(course);
        });

        var course = $('#course').val();
        updateData(course);
    });
  </script>
{% endblock %}